<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Гэрлэн дохио удирдлагын систем</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            background-color: #f5f5f5;
        }
        .header {
            background-color: #343a40;
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .traffic-light {
            width: 80px;
            height: 220px;
            background-color: #333;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-around;
            padding: 15px 0;
            margin: 0 auto;
        }
        .light {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            opacity: 0.3;
        }
        .red { background-color: red; }
        .yellow { background-color: yellow; }
        .green { background-color: green; }
        
        .active {
            opacity: 1;
            box-shadow: 0 0 20px 5px rgba(255, 255, 255, 0.6);
        }
        
        .card {
            transition: all 0.3s;
            margin-bottom: 20px;
            border: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        .card-header {
            font-weight: bold;
            background-color: #007bff;
            color: white;
        }
        .timer {
            font-size: 24px;
            font-weight: bold;
            margin: 15px 0;
        }
        .control-btn {
            margin: 5px;
            min-width: 100px;
        }
        .mode-toggle {
            margin: 10px 0;
        }
        .dashboard-title {
            margin-bottom: 30px;
        }
        .congestion-low { color: green; }
        .congestion-medium { color: orange; }
        .congestion-high { color: red; }
        .congestion-very_high { color: darkred; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h1><i class="bi bi-stoplights"></i> Гэрлэн дохио удирдлагын систем</h1>
                </div>
                <div class="col-md-4 text-end">
                    <div id="currentTime" class="fs-4"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row mb-4">
            <div class="col">
                <div class="alert alert-primary" role="alert">
                    <h4><i class="bi bi-info-circle"></i> Түгжрэлийн мэдээлэл</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p>Одоогийн түгжрэлийн түвшин: 
                                <span id="congestionLevel" class="fw-bold congestion-medium">Дунд зэрэг</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p>Минутад тоологдсон машин: <span id="vehiclesPerMinute" class="fw-bold">0</span></p>
                        </div>
                    </div>
                    <div class="progress">
                        <div id="congestionBar" class="progress-bar" role="progressbar" style="width: 25%;" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100">25%</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12 text-center mb-4">
                <h2 class="dashboard-title">Гэрлэн дохионы хяналтын самбар</h2>
            </div>
        </div>
        
        <div id="trafficLightsContainer" class="row">
            <!-- Traffic lights will be added here dynamically -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        // Socket connection
        const socket = io();
        
        // Traffic lights data
        let trafficLights = [];
        
        // Update current time
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString();
        }
        setInterval(updateTime, 1000);
        updateTime();
        
        // Create traffic light UI
        function createTrafficLightCard(light) {
            return `
                <div class="col-md-4" id="light-card-${light.id}">
                    <div class="card">
                        <div class="card-header">
                            ${light.name} - ${light.location}
                        </div>
                        <div class="card-body text-center">
                            <div class="traffic-light">
                                <div class="light red ${light.currentState === 'red' ? 'active' : ''}"></div>
                                <div class="light yellow ${light.currentState === 'yellow' ? 'active' : ''}"></div>
                                <div class="light green ${light.currentState === 'green' ? 'active' : ''}"></div>
                            </div>
                            
                            <div class="timer" id="timer-${light.id}">${light.timeLeft} сек</div>
                            
                            <div class="form-check form-switch mode-toggle">
                                <input class="form-check-input" type="checkbox" id="autoMode-${light.id}" ${light.autoControl ? 'checked' : ''}>
                                <label class="form-check-label" for="autoMode-${light.id}">
                                    ${light.autoControl ? 'Автомат горим' : 'Гар удирдлага'}
                                </label>
                            </div>
                            
                            <div class="control-buttons">
                                <button class="btn btn-danger control-btn" data-light="${light.id}" data-state="red">Улаан</button>
                                <button class="btn btn-warning control-btn" data-light="${light.id}" data-state="yellow">Шар</button>
                                <button class="btn btn-success control-btn" data-light="${light.id}" data-state="green">Ногоон</button>
                            </div>
                            
                            <div class="timing-info mt-3">
                                <p class="mb-1">Хугацааны тохиргоо:</p>
                                <div class="row">
                                    <div class="col">
                                        <span class="badge bg-success">Ногоон: ${light.timing.green}s</span>
                                    </div>
                                    <div class="col">
                                        <span class="badge bg-warning text-dark">Шар: ${light.timing.yellow}s</span>
                                    </div>
                                    <div class="col">
                                        <span class="badge bg-danger">Улаан: ${light.timing.red}s</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Update traffic light
        function updateTrafficLight(lightId, state, timeLeft) {
            const cardElement = document.getElementById(`light-card-${lightId}`);
            if (!cardElement) return;
            
            // Update active light
            const lights = cardElement.querySelectorAll('.light');
            lights.forEach(light => light.classList.remove('active'));
            
            if (state === 'red') {
                cardElement.querySelector('.red').classList.add('active');
            } else if (state === 'yellow') {
                cardElement.querySelector('.yellow').classList.add('active');
            } else if (state === 'green') {
                cardElement.querySelector('.green').classList.add('active');
            }
            
            // Update timer
            if (timeLeft !== undefined) {
                document.getElementById(`timer-${lightId}`).textContent = `${timeLeft} сек`;
            }
        }
        
        // Update timing badges
        function updateTimingBadges(lightId, timing) {
            const cardElement = document.getElementById(`light-card-${lightId}`);
            if (!cardElement) return;
            
            const timingInfo = cardElement.querySelector('.timing-info .row');
            timingInfo.innerHTML = `
                <div class="col">
                    <span class="badge bg-success">Ногоон: ${timing.green}s</span>
                </div>
                <div class="col">
                    <span class="badge bg-warning text-dark">Шар: ${timing.yellow}s</span>
                </div>
                <div class="col">
                    <span class="badge bg-danger">Улаан: ${timing.red}s</span>
                </div>
            `;
        }
        
        // Update congestion info
        function updateCongestionInfo(level, vehiclesPerMinute) {
            const levelElement = document.getElementById('congestionLevel');
            const vehiclesElement = document.getElementById('vehiclesPerMinute');
            const progressBar = document.getElementById('congestionBar');
            
            // Remove previous classes
            levelElement.className = '';
            levelElement.classList.add('fw-bold');
            
            let levelText = 'Тодорхойгүй';
            let progressPercent = 0;
            let barColor = 'bg-info';
            
            if (level === 'low') {
                levelText = 'Бага';
                progressPercent = 25;
                barColor = 'bg-success';
                levelElement.classList.add('congestion-low');
            } else if (level === 'medium') {
                levelText = 'Дунд зэрэг';
                progressPercent = 50;
                barColor = 'bg-warning';
                levelElement.classList.add('congestion-medium');
            } else if (level === 'high') {
                levelText = 'Өндөр';
                progressPercent = 75;
                barColor = 'bg-danger';
                levelElement.classList.add('congestion-high');
            } else if (level === 'very_high') {
                levelText = 'Маш өндөр';
                progressPercent = 100;
                barColor = 'bg-danger';
                levelElement.classList.add('congestion-very_high');
            }
            
            levelElement.textContent = levelText;
            vehiclesElement.textContent = vehiclesPerMinute;
            
            progressBar.style.width = `${progressPercent}%`;
            progressBar.textContent = `${progressPercent}%`;
            
            // Remove previous classes and add new one
            progressBar.className = 'progress-bar';
            progressBar.classList.add(barColor);
        }
        
        // Socket event handlers
        socket.on('trafficLightInit', (lights) => {
            trafficLights = lights;
            const container = document.getElementById('trafficLightsContainer');
            
            // Create cards for each traffic light
            const cardsHtml = lights.map(light => createTrafficLightCard(light)).join('');
            container.innerHTML = cardsHtml;
            
            // Add event listeners
            document.querySelectorAll('.control-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const lightId = button.dataset.light;
                    const state = button.dataset.state;
                    
                    socket.emit('manualControl', {
                        lightId: lightId,
                        state: state
                    });
                });
            });
            
            document.querySelectorAll('[id^="autoMode-"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const lightId = checkbox.id.split('-')[1];
                    const isAuto = checkbox.checked;
                    
                    // Update label
                    checkbox.nextElementSibling.textContent = isAuto ? 'Автомат горим' : 'Гар удирдлага';
                    
                    socket.emit('manualControl', {
                        lightId: lightId,
                        autoControl: isAuto
                    });
                });
            });
        });
        
        socket.on('trafficLightUpdate', (data) => {
            updateTrafficLight(data.id, data.state, data.timeLeft);
        });
        
        socket.on('trafficLightCountdown', (data) => {
            const timerElement = document.getElementById(`timer-${data.id}`);
            if (timerElement) {
                timerElement.textContent = `${data.timeLeft} сек`;
            }
        });
        
        socket.on('timingUpdate', (lights) => {
            lights.forEach(light => {
                updateTimingBadges(light.id, light.timing);
                
                // Update auto/manual toggle if needed
                const checkbox = document.getElementById(`autoMode-${light.id}`);
                if (checkbox && checkbox.checked !== light.autoControl) {
                    checkbox.checked = light.autoControl;
                    checkbox.nextElementSibling.textContent = light.autoControl ? 'Автомат горим' : 'Гар удирдлага';
                }
            });
        });
        
        // Fetch initial congestion data
        async function fetchCongestionData() {
            try {
                const response = await fetch('/api/lights');
                const data = await response.json();
                console.log('Initial data:', data);
                
                // Fetch congestion data from traffic analyzer API
                try {
                    const congestionResponse = await fetch('http://localhost:8000/api/congestion/current');
                    const congestionData = await congestionResponse.json();
                    console.log('Congestion data:', congestionData);
                    updateCongestionInfo(congestionData.congestion_level, congestionData.vehicles_per_minute);
                } catch (err) {
                    console.error('Failed to fetch congestion data:', err);
                    // Use default values if API is not available
                    updateCongestionInfo('medium', 8);
                }
            } catch (err) {
                console.error('Error fetching data:', err);
            }
        }
        
        // Initial fetch
        fetchCongestionData();
        
        // Refresh congestion data every 10 seconds
        setInterval(fetchCongestionData, 10000);
    </script>
</body>
</html> 